<html lang="pl" xmlns:th="http://www.thymeleaf.org">
<div class="container" style="min-height: 800px;">
    <div class="profile">
        <span id="edit-button" class="float-right"><i style="cursor: pointer;" class="fas fa-edit fa-lg"></i></span>
        <div>
            <div style="float: left;">
                <img style="width: 80px; height: 80px; display: inline-block;" th:src="${user.avatarPath}">
            </div>
            <div class="profile-content">
                <div style="display: block;">
                    <div style="display: inline-block"><span style="background-color: forestgreen; color: #ffffff; padding-left: 5px; padding-right: 5px;">Dostępny</span></div>
                    <div style="display: inline-block" th:text="'Rejestracja: ' + ${user.registrationDate}"></div>
                </div>
                <div style="width: auto; display: block">
                    <div style="display: inline-block; font-weight: bold;"th:text="${user.name}"></div>
                    <div style="display: inline-block" th:text="' | Płeć: ' + (${user.gender.name()} == 'MALE' ? 'Mężczyzna' : (${user.gender.name()} == 'UNDEFINED' ? '' : 'Kobieta'))"></div>
                    <div style="display: inline-block" th:text="'Wiek: ' + ${user.age}"></div>
                    <div style="display: inline-block" th:text="'Lokacja: ' + ${user.location}"></div>
                    <div style="display: inline-block">Budowa Ciała: </div>
                </div>
                <div style="width: auto; display:block;">
                    <div th:text="${user.description}"></div>
                </div>
            </div>
        </div>
        <hr>
        <div style="width: auto; display: table">
            <input placeholder="Wpisz nazwę utworu..."><span id="searchButton" class="input-addon"><i id="searchIcon" class="fas fa-search"></i><span id="searchButtonText"> Szukaj</span></span>
        </div>
    </div>
    <div id="chatsContainer" class="chats-container" hidden>
        <ul id="chatsTabNav" class="nav nav-tabs">
<!--            <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#user1">3123mopasd213o</a></li>-->
<!--            <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#user2">0dsa_dsad_dasm0_DAS</a></li>-->
        </ul>
<!--        <div class="chat-tab">-->
<!--            <label class="chat-tab-label"></label>-->
<!--        </div>-->
        <div id="tabsContainer" class="tab-content">
<!--            <div id="user1" class="tab-pane fade in active">-->
<!--                <div class="chat-content"></div>-->
<!--                <div class="chat-input">-->
<!--                    <input placeholder="Wprowadź tu swoją wiadomość">-->
<!--                </div>-->
<!--            </div>-->
<!--            <div id="user2" class="tab-pane fade">-->
<!--                <div class="chat-content"></div>-->
<!--                <div class="chat-input">-->
<!--                    <input placeholder="Wprowadź tu swoją wiadomość">-->
<!--                </div>-->
<!--            </div>-->
        </div>
    </div>

    <div hidden>
        <div id="chatTabPaneTemplate" class="tab-pane fade in">
            <div class="chat-content"></div>
            <div class="chat-input">
                <input placeholder="Wprowadź tu swoją wiadomość">
            </div>
        </div>

        <li id="tabNavTemplate" class="nav-item"><a class="nav-link active" data-toggle="tab" href=""></a></li>

<!--        <div class="chat-tab-template">-->
<!--            <label class="chat-tab-label"></label>-->
<!--        </div>-->

        <p id="messageTemplate">
            <span class="message-time font-weight-bold"></span>
            <span class="message-author font-weight-bold"></span>
            <span class="message-body"></span>
        </p>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/

    var currentUsername = /*[[${user.name}]]*/ 'username';
    var webSocketUrl = /*[[${webSocketUrl}]]*/ 'webSocketUrl';

    /*]]>*/

    var chatSocket = undefined;

    function formatTime(date) {
        let hours = date.getHours();
        let minutes = date.getMinutes();

        let hoursAsString = hours.toString();
        let minutesAsString = minutes.toString();

        if (hoursAsString.length === 1) {
            hoursAsString = "0" + hoursAsString;
        }

        if (minutesAsString.length === 1) {
            minutesAsString = "0" + minutesAsString;
        }

        return hoursAsString + ":" + minutesAsString;
    }

    $(document).ready(function () {
        console.log("Registering event...");
        $("#edit-button").on("click", function () {
            $("#loader").addClass("loader");
            $("#modalBodyMessage").text("Strona edycji profilu nie jest jeszcze dostępna.");
            $("#loader").removeClass("loader");
            $("#modalMessage").modal("show");
        });

        $("#searchButton").on("click", function () {
            console.log("search click!");
            $("#searchButtonText").text("");
            $("#searchIcon").removeClass();
            $("#searchIcon").addClass("fas fa-circle-notch fa-spin");

            //Replace this timeout with function that searches for a youtube video
            setTimeout(function () {
                $("#searchButtonText").text(" Szukaj");
                $("#searchIcon").removeClass();
                $("#searchIcon").addClass("fas fa-search");
                console.log("BOOM");
            }, 2000)
        });

        $("#messageInput").keydown(function (event) {
            if (event.key === "Enter" || event.code === "Enter") {
                messageInput();
            }
        });

        //Create socket
        console.log("Connecting to WebSocket Server...");
        // chatSocket = new WebSocket(webSocketUrl);
        chatSocket = new WebSocket(webSocketUrl, {
            origin: "https://secretchat.bartlomiejstepien.pl:6660",
            rejectUnauthorized: false
        });
        console.log("Connected!");

        chatSocket.onopen = function (event) {
            let json = {};
            json["from"] = currentUsername;
            json["type"] = "handshake";
            console.log(json);
            chatSocket.send(JSON.stringify(json));
        };

        chatSocket.onmessage = function (event) {
            console.log(event.data);

            let receivedData = JSON.parse(event.data);
            console.log(receivedData);
            console.log(receivedData["type"]);
            if (receivedData["type"] !== undefined && receivedData["type"] === "handshake") {
                //Open new chat tab
                console.log("Opening new chat tab...");

                if ($("#chatsContainer").attr("hidden")) {
                    console.log("Removing hidden attribute...");
                    $("#chatsContainer").removeAttr('hidden');
                    // $("#chatsContainer").show("slow");
                    console.log("Showing chatsContainer...");
                }

                let tabNavTemplate = $("#tabNavTemplate").clone();
                tabNavTemplate.attr("id", receivedData["from"]);
                tabNavTemplate.find(".nav-link").text(receivedData["from"]);
                tabNavTemplate.find(".nav-link").attr("href", "#" + receivedData["from"] + "-tab")
                $("#chatsTabNav").append(tabNavTemplate);

                let chatTabPaneTemplate = $("#chatTabPaneTemplate").clone();
                chatTabPaneTemplate.attr("id", receivedData["from"] + "-tab");
                chatTabPaneTemplate.find(".chat-content").attr("id", receivedData["from"] + "-chat");
                chatTabPaneTemplate.addClass("active show");

                //Setup input field
                $("#tabsContainer").append(chatTabPaneTemplate);
                console.log(chatTabPaneTemplate);
                let inputField = chatTabPaneTemplate.find(".chat-input input");
                console.log(inputField);
                inputField.attr("id", receivedData["from"] + "-input");

                inputField.keydown(function (event) {
                    if (event.key === "Enter" || event.code === "Enter") {
                        sendMessage(this);
                    }
                });
            }
            else if (receivedData["type"] !== undefined && receivedData["type"] === "message") {
                //Find correct tab
                let chatContent = $("#" + receivedData["from"] + "-chat");
                let messageTemplate = $("#messageTemplate").clone();
                messageTemplate.find(".message-time").text(formatTime(new Date())); //Time should be sent from the server
                messageTemplate.find(".message-author").text(receivedData["from"] + ": ");
                messageTemplate.find(".message-body").text(receivedData["message"]);
                chatContent.append(messageTemplate);
            }
        }
    });

    function sendMessage(inputElement) {
        console.log(inputElement);
        let inputId = inputElement.id;
        let toUser = inputId.substring(0, inputId.length - 6);

        console.log("Input Id = " + inputId);
        console.log("To User = " + toUser);

        let json = {};
        json["from"] = currentUsername;
        json["to"] = toUser;
        json["type"] = "message";
        json["message"] = inputElement.value;
        chatSocket.send(JSON.stringify(json));

        let messageTemplate = $("#messageTemplate").clone();
        messageTemplate.find(".message-time").text(formatTime(new Date()))
        messageTemplate.find(".message-author").text("Ty: ");
        messageTemplate.find(".message-body").text(inputElement.value);
        $("#" + toUser + "-chat").append(messageTemplate);
        //Clear message input field
        inputElement.value = "";
    }
</script>

</html>